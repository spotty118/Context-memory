<!-- API Keys Table -->
<div class="bg-white shadow overflow-hidden sm:rounded-md">
    {% if new_key %}
    <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-green-800">API Key Created Successfully</h3>
                <div class="mt-2 text-sm text-green-700">
                    <p><strong>{{ new_key_name }}</strong></p>
                    <div class="bg-white p-3 rounded border mt-2 font-mono text-xs">
                        <div class="flex items-center justify-between">
                            <span>{{ new_key }}</span>
                            <button onclick="copyToClipboard('{{ new_key }}')" class="ml-2 text-green-600 hover:text-green-800">
                                <i data-lucide="copy" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-xs mt-1"><strong>Important:</strong> Copy this key now. You won't be able to see it again!</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <ul class="divide-y divide-gray-200">
        {% for key in api_keys %}
        <li>
            <div class="px-4 py-4 flex items-center justify-between">
                <div class="flex items-center">
                    <div class="flex-shrink-0 h-10 w-10">
                        <div class="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center">
                            <i data-lucide="key" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900">{{ key.key_name }}</div>
                        <div class="text-sm text-gray-500">{{ key.description or 'No description' }}</div>
                        <div class="text-xs text-gray-400">
                            Created {{ key.created_at.strftime('%Y-%m-%d %H:%M') }} by {{ key.created_by }}
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                        {% if key.is_active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                        {% if key.is_active %}Active{% else %}Suspended{% endif %}
                    </span>
                    <div class="flex space-x-1">
                        {% if key.is_active %}
                        <button onclick="suspendKey('{{ key.id }}')" 
                                class="text-yellow-600 hover:text-yellow-900 text-sm">
                            <i data-lucide="pause-circle" class="w-4 h-4"></i>
                        </button>
                        {% else %}
                        <button onclick="activateKey('{{ key.id }}')" 
                                class="text-green-600 hover:text-green-900 text-sm">
                            <i data-lucide="play-circle" class="w-4 h-4"></i>
                        </button>
                        {% endif %}
                        <button onclick="deleteKey('{{ key.id }}')" 
                                class="text-red-600 hover:text-red-900 text-sm">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </li>
        {% else %}
        <li class="px-4 py-8 text-center">
            <div class="text-gray-500">
                <i data-lucide="key" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                <p>No API keys found</p>
                <p class="text-sm">Create your first API key to get started</p>
            </div>
        </li>
        {% endfor %}
    </ul>
</div>

<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showNotification('API key copied to clipboard', 'success');
    });
}

async function suspendKey(keyId) {
    if (!confirm('Are you sure you want to suspend this API key?')) return;
    
    try {
        const response = await makeAuthenticatedRequest(`/admin/api-keys/${keyId}/suspend`, {
            method: 'POST'
        });
        
        if (response.ok) {
            showNotification('API key suspended', 'success');
            htmx.trigger('#api-keys-table', 'refresh');
        } else {
            showNotification('Failed to suspend API key', 'error');
        }
    } catch (error) {
        showNotification('Error suspending API key', 'error');
    }
}

async function activateKey(keyId) {
    try {
        const response = await makeAuthenticatedRequest(`/admin/api-keys/${keyId}/activate`, {
            method: 'POST'
        });
        
        if (response.ok) {
            showNotification('API key activated', 'success');
            htmx.trigger('#api-keys-table', 'refresh');
        } else {
            showNotification('Failed to activate API key', 'error');
        }
    } catch (error) {
        showNotification('Error activating API key', 'error');
    }
}

async function deleteKey(keyId) {
    if (!confirm('Are you sure you want to delete this API key? This action cannot be undone.')) return;
    
    try {
        const response = await makeAuthenticatedRequest(`/admin/api-keys/${keyId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showNotification('API key deleted', 'success');
            htmx.trigger('#api-keys-table', 'refresh');
        } else {
            showNotification('Failed to delete API key', 'error');
        }
    } catch (error) {
        showNotification('Error deleting API key', 'error');
    }
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}
</script>
