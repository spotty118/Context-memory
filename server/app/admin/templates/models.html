{% extends "base.html" %}

{% block title %}Models - Context Memory Gateway{% endblock %}
{% block page_title %}Model Catalog{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Header with Sync Button -->
    <div class="sm:flex sm:items-center sm:justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Model Catalog</h1>
            <p class="mt-2 text-sm text-gray-700">Manage and monitor available AI models from OpenRouter</p>
        </div>
        <div class="mt-4 sm:mt-0 flex space-x-3">
            <button type="button" 
                    class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors"
                    hx-get="/admin/models/sync-status"
                    hx-target="#sync-status">
                <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                Check Sync Status
            </button>
            <button type="button" 
                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors"
                    hx-post="/admin/models/sync"
                    hx-target="#models-table"
                    hx-indicator="#sync-indicator">
                <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                Sync from OpenRouter
            </button>
        </div>
    </div>

    <!-- Sync Status -->
    <div id="sync-status" class="mb-6">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i data-lucide="info" class="w-5 h-5 text-blue-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-blue-700">
                        Last sync: <span class="font-medium">{{ last_sync | default('2 hours ago') }}</span>
                        • {{ total_models | default('127') }} models available
                        • {{ active_models | default('89') }} active
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 gap-6 sm:grid-cols-4 mb-8">
        <div class="bg-white overflow-hidden shadow rounded-lg card-hover">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                            <i data-lucide="check-circle" class="w-4 h-4 text-white"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Active Models</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ stats.active_models | default('89') }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg card-hover">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                            <i data-lucide="pause-circle" class="w-4 h-4 text-white"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Deprecated</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ stats.deprecated_models | default('23') }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg card-hover">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                            <i data-lucide="trending-up" class="w-4 h-4 text-white"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Most Used</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ stats.most_used_model | default('GPT-4') }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg card-hover">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
                            <i data-lucide="zap" class="w-4 h-4 text-white"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Total Requests</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ stats.total_requests | default('45.2K') }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="bg-white shadow rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-3 sm:space-y-0">
                <div class="flex-1 min-w-0">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="search" class="w-4 h-4 text-gray-400"></i>
                        </div>
                        <input type="text" 
                               placeholder="Search models..." 
                               class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                               hx-get="/admin/models/search"
                               hx-target="#models-table"
                               hx-trigger="keyup changed delay:300ms"
                               name="q">
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <select class="block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                            hx-get="/admin/models/filter"
                            hx-target="#models-table"
                            hx-trigger="change"
                            name="provider">
                        <option value="">All Providers</option>
                        <option value="openai">OpenAI</option>
                        <option value="anthropic">Anthropic</option>
                        <option value="google">Google</option>
                        <option value="meta">Meta</option>
                        <option value="mistral">Mistral</option>
                    </select>
                    <select class="block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                            hx-get="/admin/models/filter"
                            hx-target="#models-table"
                            hx-trigger="change"
                            name="status">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="deprecated">Deprecated</option>
                        <option value="unavailable">Unavailable</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Sync Indicator -->
    <div id="sync-indicator" class="htmx-indicator fixed top-4 right-4 z-50">
        <div class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-lg flex items-center">
            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
            Syncing models...
        </div>
    </div>

    <!-- Models Table -->
    <div class="bg-white shadow rounded-lg overflow-hidden" id="models-table">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Model
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Provider
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Pricing
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Context
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Status
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Usage
                    </th>
                    <th scope="col" class="relative px-6 py-3">
                        <span class="sr-only">Actions</span>
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for model in models | default([
                    {
                        'id': 'openai/gpt-4',
                        'name': 'GPT-4',
                        'provider': 'OpenAI',
                        'input_cost': 0.03,
                        'output_cost': 0.06,
                        'context_length': 8192,
                        'status': 'active',
                        'requests_count': 15678,
                        'description': 'Most capable GPT-4 model'
                    },
                    {
                        'id': 'anthropic/claude-3-opus',
                        'name': 'Claude 3 Opus',
                        'provider': 'Anthropic',
                        'input_cost': 0.015,
                        'output_cost': 0.075,
                        'context_length': 200000,
                        'status': 'active',
                        'requests_count': 8934,
                        'description': 'Most powerful Claude model'
                    },
                    {
                        'id': 'google/gemini-pro',
                        'name': 'Gemini Pro',
                        'provider': 'Google',
                        'input_cost': 0.00025,
                        'output_cost': 0.0005,
                        'context_length': 32768,
                        'status': 'active',
                        'requests_count': 5432,
                        'description': 'Google\'s multimodal AI model'
                    },
                    {
                        'id': 'openai/gpt-3.5-turbo',
                        'name': 'GPT-3.5 Turbo',
                        'provider': 'OpenAI',
                        'input_cost': 0.0015,
                        'output_cost': 0.002,
                        'context_length': 16384,
                        'status': 'deprecated',
                        'requests_count': 2156,
                        'description': 'Legacy GPT-3.5 model'
                    }
                ]) %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-8 w-8">
                                <div class="h-8 w-8 rounded-full bg-gradient-to-r from-purple-400 to-pink-400 flex items-center justify-center">
                                    <i data-lucide="cpu" class="w-4 h-4 text-white"></i>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">{{ model.name }}</div>
                                <div class="text-sm text-gray-500">{{ model.id }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">{{ model.provider }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">
                            ${{ "%.4f"|format(model.input_cost) }}/1K input
                        </div>
                        <div class="text-sm text-gray-500">
                            ${{ "%.4f"|format(model.output_cost) }}/1K output
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">{{ "{:,}".format(model.context_length) }}</div>
                        <div class="text-sm text-gray-500">tokens</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if model.status == 'active' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <div class="w-1.5 h-1.5 bg-green-400 rounded-full mr-1.5"></div>
                            Active
                        </span>
                        {% elif model.status == 'deprecated' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                            <div class="w-1.5 h-1.5 bg-yellow-400 rounded-full mr-1.5"></div>
                            Deprecated
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            <div class="w-1.5 h-1.5 bg-red-400 rounded-full mr-1.5"></div>
                            Unavailable
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">{{ "{:,}".format(model.requests_count) }}</div>
                        <div class="text-sm text-gray-500">requests</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex items-center space-x-2">
                            <button class="text-indigo-600 hover:text-indigo-900 p-1 rounded"
                                    hx-get="/admin/models/{{ model.id | urlencode }}/details"
                                    hx-target="#modal-container"
                                    title="View Details">
                                <i data-lucide="info" class="w-4 h-4"></i>
                            </button>
                            <button class="text-gray-600 hover:text-gray-900 p-1 rounded"
                                    hx-get="/admin/models/{{ model.id | urlencode }}/usage"
                                    hx-target="#modal-container"
                                    title="Usage Analytics">
                                <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                            </button>
                            {% if model.status == 'active' %}
                            <button class="text-yellow-600 hover:text-yellow-900 p-1 rounded"
                                    hx-post="/admin/models/{{ model.id | urlencode }}/disable"
                                    hx-target="#models-table"
                                    hx-confirm="Are you sure you want to disable this model?"
                                    title="Disable">
                                <i data-lucide="pause" class="w-4 h-4"></i>
                            </button>
                            {% elif model.status == 'deprecated' %}
                            <button class="text-green-600 hover:text-green-900 p-1 rounded"
                                    hx-post="/admin/models/{{ model.id | urlencode }}/enable"
                                    hx-target="#models-table"
                                    title="Enable">
                                <i data-lucide="play" class="w-4 h-4"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- Pagination -->
        <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                <button class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Previous
                </button>
                <button class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Next
                </button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        Showing <span class="font-medium">1</span> to <span class="font-medium">20</span> of <span class="font-medium">127</span> results
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <button class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <i data-lucide="chevron-left" class="w-4 h-4"></i>
                        </button>
                        <button class="bg-indigo-50 border-indigo-500 text-indigo-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium">1</button>
                        <button class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">2</button>
                        <button class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">3</button>
                        <button class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <i data-lucide="chevron-right" class="w-4 h-4"></i>
                        </button>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Auto-refresh models every 5 minutes
    setInterval(function() {
        htmx.trigger('#models-table', 'refresh');
    }, 300000);
</script>
{% endblock %}

