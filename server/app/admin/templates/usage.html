{% extends "base.html" %}

{% block title %}Usage Analytics - Context Memory Gateway{% endblock %}
{% block page_title %}Usage Analytics{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Header with Time Range Selector -->
    <div class="sm:flex sm:items-center sm:justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Usage Analytics</h1>
            <p class="mt-2 text-sm text-gray-700">Monitor API usage, performance metrics, and system health</p>
        </div>
        <div class="mt-4 sm:mt-0">
            <div class="flex items-center space-x-3">
                <select id="timeRange" onchange="updateTimeRange()" class="block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d" selected>Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                    <option value="90d">Last 90 Days</option>
                </select>
                <button type="button" 
                        onclick="exportAnalytics()"
                        class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                    <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                    Export
                </button>
            </div>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4 mb-8">
        <div class="bg-white overflow-hidden shadow rounded-lg card-hover">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                            <i data-lucide="zap" class="w-4 h-4 text-white"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Total Requests</dt>
                            <dd class="text-lg font-medium text-gray-900" data-metric="total-requests">{{ analytics.total_requests | default('45,678') }}</dd>
                        </dl>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="flex items-center text-sm text-green-600">
                        <i data-lucide="trending-up" class="w-4 h-4 mr-1"></i>
                        <span>+12.5% from last period</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg card-hover">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                            <i data-lucide="clock" class="w-4 h-4 text-white"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Avg Response Time</dt>
                            <dd class="text-lg font-medium text-gray-900" data-metric="avg-response-time">{{ analytics.avg_response_time | default('245ms') }}</dd>
                        </dl>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="flex items-center text-sm text-green-600">
                        <i data-lucide="trending-down" class="w-4 h-4 mr-1"></i>
                        <span>-8ms from last period</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg card-hover">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
                            <i data-lucide="dollar-sign" class="w-4 h-4 text-white"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Total Cost</dt>
                            <dd class="text-lg font-medium text-gray-900" data-metric="total-cost">{{ analytics.total_cost | default('$1,234.56') }}</dd>
                        </dl>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="flex items-center text-sm text-red-600">
                        <i data-lucide="trending-up" class="w-4 h-4 mr-1"></i>
                        <span>+5.2% from last period</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg card-hover">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-orange-500 rounded-md flex items-center justify-center">
                            <i data-lucide="alert-triangle" class="w-4 h-4 text-white"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Error Rate</dt>
                            <dd class="text-lg font-medium text-gray-900" data-metric="error-rate">{{ analytics.error_rate | default('0.12%') }}</dd>
                        </dl>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="flex items-center text-sm text-green-600">
                        <i data-lucide="trending-down" class="w-4 h-4 mr-1"></i>
                        <span>-0.03% from last period</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Request Volume Over Time -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Request Volume</h3>
                <div class="flex items-center space-x-2">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                        <span class="text-sm text-gray-600">Requests</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                        <span class="text-sm text-gray-600">Successful</span>
                    </div>
                </div>
            </div>
            <div class="h-64">
                <canvas id="requestVolumeChart"></canvas>
            </div>
        </div>

        <!-- Response Time Distribution -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Response Time Distribution</h3>
                <i data-lucide="clock" class="w-5 h-5 text-gray-400"></i>
            </div>
            <div class="h-64">
                <canvas id="responseTimeChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Model Usage and Top Endpoints -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Model Usage -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Model Usage</h3>
                <i data-lucide="cpu" class="w-5 h-5 text-gray-400"></i>
            </div>
            <div class="space-y-4">
                {% for model, percentage in [
                    ('GPT-4', 35),
                    ('Claude-3 Opus', 25),
                    ('Gemini Pro', 20),
                    ('GPT-3.5 Turbo', 15),
                    ('Others', 5)
                ] %}
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full mr-3" style="background-color: {{ ['#8B5CF6', '#06B6D4', '#10B981', '#F59E0B', '#EF4444'][loop.index0] }}"></div>
                        <span class="text-sm font-medium text-gray-900">{{ model }}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-20 bg-gray-200 rounded-full h-2">
                            <div class="h-2 rounded-full" style="width: {{ percentage }}%; background-color: {{ ['#8B5CF6', '#06B6D4', '#10B981', '#F59E0B', '#EF4444'][loop.index0] }}"></div>
                        </div>
                        <span class="text-sm text-gray-600 w-8">{{ percentage }}%</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Top Endpoints -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Top Endpoints</h3>
                <i data-lucide="trending-up" class="w-5 h-5 text-gray-400"></i>
            </div>
            <div class="space-y-4">
                {% for endpoint, requests, change in [
                    ('/v1/chat/completions', '28,456', '+12%'),
                    ('/v1/recall', '8,234', '+8%'),
                    ('/v1/ingest', '5,678', '+15%'),
                    ('/v1/workingset', '3,456', '+5%'),
                    ('/v1/expand', '2,134', '+3%')
                ] %}
                <div class="flex items-center justify-between py-2">
                    <div>
                        <div class="text-sm font-medium text-gray-900">{{ endpoint }}</div>
                        <div class="text-xs text-gray-500">{{ requests }} requests</div>
                    </div>
                    <div class="text-sm text-green-600">{{ change }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Error Analysis and Performance Metrics -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Error Analysis -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Error Analysis</h3>
                <i data-lucide="alert-circle" class="w-5 h-5 text-gray-400"></i>
            </div>
            <div class="space-y-4">
                {% for error_type, count, percentage in [
                    ('Rate Limit Exceeded', 45, 42),
                    ('Invalid API Key', 28, 26),
                    ('Model Not Available', 18, 17),
                    ('Timeout', 12, 11),
                    ('Other', 4, 4)
                ] %}
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm font-medium text-gray-900">{{ error_type }}</div>
                        <div class="text-xs text-gray-500">{{ count }} errors</div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-16 bg-gray-200 rounded-full h-2">
                            <div class="bg-red-500 h-2 rounded-full" style="width: {{ percentage }}%"></div>
                        </div>
                        <span class="text-sm text-gray-600 w-8">{{ percentage }}%</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="bg-white shadow rounded-lg p-6" data-section="performance-metrics">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Performance Metrics</h3>
                <i data-lucide="activity" class="w-5 h-5 text-gray-400"></i>
            </div>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-900">P50 Response Time</span>
                    <span class="text-sm text-gray-600" data-metric="p50">185ms</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-900">P95 Response Time</span>
                    <span class="text-sm text-gray-600" data-metric="p95">450ms</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-900">P99 Response Time</span>
                    <span class="text-sm text-gray-600" data-metric="p99">890ms</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-900">Uptime</span>
                    <span class="text-sm text-green-600" data-metric="uptime">99.97%</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-900">Throughput</span>
                    <span class="text-sm text-gray-600" data-metric="throughput">45.2 req/sec</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-900">Cache Hit Rate</span>
                    <span class="text-sm text-blue-600" data-metric="cache-hit-rate">78.5%</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentTimeRange = '7d';
    let requestVolumeChart = null;
    let responseTimeChart = null;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadAnalyticsData();
        loadPerformanceMetrics();
        loadErrorAnalysis();
        initCharts();
    });

    // Update time range and reload data
    function updateTimeRange() {
        const timeRange = document.getElementById('timeRange').value;
        currentTimeRange = timeRange;
        loadAnalyticsData();
        loadPerformanceMetrics();
        loadErrorAnalysis();
    }

    // Load usage analytics data
    async function loadAnalyticsData() {
        try {
            const response = await makeAuthenticatedRequest(`/admin/analytics/usage?time_range=${currentTimeRange}`, {
                method: 'GET'
            });

            if (response.ok) {
                const data = await response.json();
                updateAnalyticsUI(data);
                updateCharts(data);
            } else {
                showNotification('Failed to load analytics data', 'error');
            }
        } catch (error) {
            console.error('Error loading analytics data:', error);
            showNotification('Error loading analytics data', 'error');
        }
    }

    // Load performance metrics
    async function loadPerformanceMetrics() {
        try {
            const response = await makeAuthenticatedRequest(`/admin/analytics/performance?time_range=${currentTimeRange}`, {
                method: 'GET'
            });

            if (response.ok) {
                const data = await response.json();
                updatePerformanceMetrics(data);
            } else {
                showNotification('Failed to load performance metrics', 'error');
            }
        } catch (error) {
            console.error('Error loading performance metrics:', error);
            showNotification('Error loading performance metrics', 'error');
        }
    }

    // Load error analysis data
    async function loadErrorAnalysis() {
        try {
            const response = await makeAuthenticatedRequest(`/admin/analytics/errors?time_range=${currentTimeRange}`, {
                method: 'GET'
            });

            if (response.ok) {
                const data = await response.json();
                updateErrorAnalysis(data);
            } else {
                showNotification('Failed to load error analysis', 'error');
            }
        } catch (error) {
            console.error('Error loading error analysis:', error);
            showNotification('Error loading error analysis', 'error');
        }
    }

    // Export analytics data
    async function exportAnalytics() {
        try {
            const response = await makeAuthenticatedRequest(`/admin/analytics/export?time_range=${currentTimeRange}&format=csv`, {
                method: 'GET'
            });

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `analytics_${currentTimeRange}_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                showNotification('Analytics exported successfully', 'success');
            } else {
                showNotification('Failed to export analytics', 'error');
            }
        } catch (error) {
            console.error('Error exporting analytics:', error);
            showNotification('Error exporting analytics', 'error');
        }
    }

    // Update analytics UI with real data
    function updateAnalyticsUI(data) {
        // Update key metrics cards
        const totalRequestsEl = document.querySelector('[data-metric="total-requests"]');
        const avgResponseTimeEl = document.querySelector('[data-metric="avg-response-time"]');
        const totalCostEl = document.querySelector('[data-metric="total-cost"]');
        const errorRateEl = document.querySelector('[data-metric="error-rate"]');

        if (totalRequestsEl) totalRequestsEl.textContent = data.total_requests?.toLocaleString() || '0';
        if (avgResponseTimeEl) avgResponseTimeEl.textContent = data.avg_response_time ? `${data.avg_response_time}ms` : '0ms';
        if (totalCostEl) totalCostEl.textContent = data.total_cost ? `$${data.total_cost.toFixed(2)}` : '$0.00';
        if (errorRateEl) errorRateEl.textContent = data.error_rate ? `${data.error_rate.toFixed(2)}%` : '0.00%';

        // Update model usage if available
        if (data.model_usage) {
            updateModelUsage(data.model_usage);
        }

        // Update top endpoints if available
        if (data.top_endpoints) {
            updateTopEndpoints(data.top_endpoints);
        }
    }

    // Update performance metrics
    function updatePerformanceMetrics(data) {
        const metricsContainer = document.querySelector('[data-section="performance-metrics"]');
        if (!metricsContainer || !data.metrics) return;

        const metrics = data.metrics;
        const metricElements = {
            'p50': metricsContainer.querySelector('[data-metric="p50"]'),
            'p95': metricsContainer.querySelector('[data-metric="p95"]'),
            'p99': metricsContainer.querySelector('[data-metric="p99"]'),
            'uptime': metricsContainer.querySelector('[data-metric="uptime"]'),
            'throughput': metricsContainer.querySelector('[data-metric="throughput"]'),
            'cache_hit_rate': metricsContainer.querySelector('[data-metric="cache-hit-rate"]')
        };

        if (metricElements.p50 && metrics.p50) metricElements.p50.textContent = `${metrics.p50}ms`;
        if (metricElements.p95 && metrics.p95) metricElements.p95.textContent = `${metrics.p95}ms`;
        if (metricElements.p99 && metrics.p99) metricElements.p99.textContent = `${metrics.p99}ms`;
        if (metricElements.uptime && metrics.uptime) metricElements.uptime.textContent = `${metrics.uptime.toFixed(2)}%`;
        if (metricElements.throughput && metrics.throughput) metricElements.throughput.textContent = `${metrics.throughput.toFixed(1)} req/sec`;
        if (metricElements.cache_hit_rate && metrics.cache_hit_rate) metricElements.cache_hit_rate.textContent = `${metrics.cache_hit_rate.toFixed(1)}%`;
    }

    // Update error analysis
    function updateErrorAnalysis(data) {
        // Implementation would update the error analysis section with real data
        // For now, we'll keep the existing static data
    }

    // Initialize charts
    function initCharts() {
        initRequestVolumeChart();
        initResponseTimeChart();
    }

    // Update charts with real data
    function updateCharts(data) {
        if (data.request_volume && requestVolumeChart) {
            requestVolumeChart.data.labels = data.request_volume.labels || ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            requestVolumeChart.data.datasets[0].data = data.request_volume.total || [4200, 5100, 4800, 6200, 5800, 4500, 3900];
            requestVolumeChart.data.datasets[1].data = data.request_volume.successful || [4150, 5050, 4750, 6150, 5750, 4450, 3850];
            requestVolumeChart.update();
        }

        if (data.response_time_distribution && responseTimeChart) {
            responseTimeChart.data.datasets[0].data = data.response_time_distribution.data || [15420, 18650, 8940, 2340, 328];
            responseTimeChart.update();
        }
    }

    function initRequestVolumeChart() {
        const ctx = document.getElementById('requestVolumeChart').getContext('2d');
        requestVolumeChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Total Requests',
                    data: [4200, 5100, 4800, 6200, 5800, 4500, 3900],
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Successful Requests',
                    data: [4150, 5050, 4750, 6150, 5750, 4450, 3850],
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    function initResponseTimeChart() {
        const ctx = document.getElementById('responseTimeChart').getContext('2d');
        responseTimeChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['0-100ms', '100-200ms', '200-500ms', '500ms-1s', '1s+'],
                datasets: [{
                    label: 'Requests',
                    data: [15420, 18650, 8940, 2340, 328],
                    backgroundColor: [
                        '#10B981',
                        '#06B6D4',
                        '#F59E0B',
                        '#EF4444',
                        '#8B5CF6'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}

